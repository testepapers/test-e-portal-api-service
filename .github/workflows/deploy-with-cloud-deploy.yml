name: Build and Deploy via Cloud Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: test-e-portal-api-service
  SERVICE_NAME: test-e-portal-api-service
  REGION: asia-south2
  REGISTRY: asia-south2-docker.pkg.dev
  REPOSITORY: test-e-portal-images
  PIPELINE_NAME: test-e-portal-pipeline

jobs:
  build-and-release:
    name: Build Image and Deploy via Cloud Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Build and Push Docker Image
        id: build-image
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          IMAGE="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${SHORT_SHA}"
          
          docker build --platform linux/amd64 -t $IMAGE .
          docker push $IMAGE
          
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "✅ Image built and pushed: $IMAGE"

      - name: Update Deployment Manifests
        id: update-manifests
        run: |
          SHORT_SHA=${{ steps.build-image.outputs.short_sha }}
          
          # Update manifests with image tag
          sed -i "s|TAG_PLACEHOLDER|${SHORT_SHA}|g" deploy/test.yaml
          sed -i "s|TAG_PLACEHOLDER|${SHORT_SHA}|g" deploy/prod.yaml
          
          # Show what was updated
          echo "Updated test.yaml:"
          grep "image:" deploy/test.yaml
          echo "Updated prod.yaml:"
          grep "image:" deploy/prod.yaml

      - name: Create Cloud Deploy Release
        id: create-release
        run: |
          SHORT_SHA=${{ steps.build-image.outputs.short_sha }}
          RELEASE_NAME="release-${SHORT_SHA}"
          
          echo "Creating Cloud Deploy release: $RELEASE_NAME"
          
          gcloud deploy releases create $RELEASE_NAME \
            --delivery-pipeline=${{ env.PIPELINE_NAME }} \
            --region=${{ env.REGION }} \
            --source=. \
            --images=${{ env.SERVICE_NAME }}=${{ steps.build-image.outputs.image }}
          
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "✅ Cloud Deploy release created: $RELEASE_NAME"

      - name: Wait for Release to be Ready
        run: |
          echo "Waiting 15 seconds for release to be fully created..."
          sleep 15

      - name: Verify Release Exists
        run: |
          RELEASE_NAME="${{ steps.create-release.outputs.release_name }}"
          
          echo "Verifying release: $RELEASE_NAME"
          
          gcloud deploy releases describe $RELEASE_NAME \
            --delivery-pipeline=${{ env.PIPELINE_NAME }} \
            --region=${{ env.REGION }}

      - name: Promote to Test
        run: |
          RELEASE_NAME="${{ steps.create-release.outputs.release_name }}"
          
          echo "Promoting $RELEASE_NAME to test..."
          
          gcloud deploy releases promote \
            --delivery-pipeline=${{ env.PIPELINE_NAME }} \
            --region=${{ env.REGION }} \
            --release=$RELEASE_NAME \
            --to-target=test \
            --quiet
          
          echo "✅ Promoted to test"
          echo "View deployment: https://console.cloud.google.com/deploy/delivery-pipelines/${{ env.REGION }}/${{ env.PIPELINE_NAME }}?project=${{ env.PROJECT_ID }}"